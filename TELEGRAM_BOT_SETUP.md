# Настройка Telegram бота

## Описание

Telegram бот позволяет создавать заявки на пропуск напрямую из Telegram, не открывая веб-интерфейс. Это особенно удобно для мобильных устройств.

## Возможности бота

- ✅ Привязка Telegram аккаунта к аккаунту в системе
- ✅ Создание заявок на пропуск через диалог с ботом
- ✅ Просмотр списка своих заявок
- ✅ Поддержка русского языка
- ✅ Интерактивные кнопки для удобства ввода

## Шаг 1: Создание бота в Telegram

1. Откройте Telegram и найдите [@BotFather](https://t.me/BotFather)
2. Отправьте команду `/newbot`
3. Следуйте инструкциям:
   - Введите имя бота (например: "Бот управления пропусками")
   - Введите username бота (должен заканчиваться на "bot", например: "cottage_pass_bot")
4. После создания бота BotFather выдаст вам токен вида: `123456789:ABCdefGHIjklMNOpqrsTUVwxyz`
5. **Сохраните этот токен!** Он понадобится для настройки

## Шаг 2: Настройка переменных окружения

1. Откройте файл `.env` в корне проекта (или создайте его)
2. Добавьте строку с токеном бота:

```env
TELEGRAM_BOT_TOKEN=ваш_токен_от_BotFather
```

Например:
```env
TELEGRAM_BOT_TOKEN=123456789:ABCdefGHIjklMNOpqrsTUVwxyz
```

3. Сохраните файл

## Шаг 3: Установка зависимостей

Если вы еще не установили зависимости, выполните:

```bash
cd backend
npm install
```

## Шаг 4: Запуск сервера

Бот автоматически запустится вместе с backend сервером:

```bash
npm run dev
```

Вы должны увидеть сообщение: `Telegram бот успешно инициализирован`

Если токен не установлен, вы увидите: `TELEGRAM_BOT_TOKEN не установлен, бот не будет запущен`

## Шаг 5: Использование бота

### Для пользователей:

1. **Привязка аккаунта:**
   - Откройте веб-интерфейс и войдите в свой аккаунт
   - Перейдите в "Профиль"
   - Нажмите "Привязать Telegram" (кнопка появится после настройки)
   - Скопируйте код привязки
   - Откройте бота в Telegram и отправьте: `/link <код_привязки>`

2. **Создание заявки:**
   - Отправьте боту команду `/create`
   - Следуйте инструкциям бота:
     - Выберите тип транспорта (легковой/грузовой)
     - Введите марку автомобиля
     - Введите номер автомобиля
     - Введите дату въезда
     - Выберите участок из списка
     - Введите комментарий (или "-" для пропуска)

3. **Просмотр заявок:**
   - Команда `/list` покажет последние 10 заявок

4. **Справка:**
   - Команда `/help` покажет все доступные команды

## Команды бота

| Команда | Описание |
|---------|----------|
| `/start` | Начать работу с ботом |
| `/link <код>` | Привязать Telegram к аккаунту |
| `/create` | Создать новую заявку на пропуск |
| `/list` | Просмотреть мои заявки (последние 10) |
| `/help` | Показать справку |

## API Endpoints для привязки

### Получить токен для привязки
```
GET /api/users/me/telegram-link-token
Authorization: Bearer <JWT_TOKEN>
```

**Ответ:**
```json
{
  "token": "abc123def456...",
  "instructions": "Использование инструкции..."
}
```

### Отвязать Telegram
```
POST /api/users/me/telegram-unlink
Authorization: Bearer <JWT_TOKEN>
```

## Интеграция с веб-интерфейсом

Для удобства пользователей можно добавить кнопку привязки Telegram в компонент профиля. Это можно реализовать отдельно, добавив:

1. Кнопку "Привязать Telegram" в ProfileModal
2. API вызов для получения токена
3. Отображение токена пользователю с инструкциями

## Технические детали

- Бот использует **long polling** для получения обновлений
- Состояния пользователей хранятся в памяти (в production лучше использовать Redis)
- Токены привязки действительны 15 минут
- Бот автоматически проверяет права доступа пользователей
- Заявки создаются через те же API endpoints, что и веб-интерфейс

## Устранение проблем

### Бот не отвечает
- Проверьте, что `TELEGRAM_BOT_TOKEN` установлен в `.env`
- Проверьте логи сервера на наличие ошибок
- Убедитесь, что бот запущен (должно быть сообщение "Telegram бот успешно инициализирован")

### Ошибка при привязке
- Проверьте, что код привязки не истек (действителен 15 минут)
- Убедитесь, что вы не пытаетесь привязать уже привязанный аккаунт
- Проверьте права доступа к API

### Бот не находит пользователя
- Убедитесь, что вы сначала привязали Telegram через `/link`
- Проверьте, что ваш Telegram ID сохранен в базе данных

## Безопасность

- ✅ Токены привязки имеют ограниченное время жизни (15 минут)
- ✅ Проверка прав доступа перед созданием заявок
- ✅ Валидация всех входных данных
- ✅ Привязка только через авторизованный веб-интерфейс

## Расширение функционала

В будущем можно добавить:
- Редактирование заявок через бота
- Удаление заявок
- Получение уведомлений о статусе заявки
- Просмотр детальной информации о заявке
- Статистику заявок

